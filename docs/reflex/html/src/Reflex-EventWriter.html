<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Reflex/EventWriter.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- | This module provides 'EventWriterT', the standard implementation of</span>
<a name="line-2"></a><span class='hs-comment'>-- 'EventWriter'.</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE ExistentialQuantification #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE FunctionalDependencies #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# LANGUAGE MultiParamTypeClasses #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# LANGUAGE Rank2Types #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-11"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-12"></a><span class='hs-comment'>{-# LANGUAGE TypeOperators #-}</span>
<a name="line-13"></a><span class='hs-comment'>{-# LANGUAGE UndecidableInstances #-}</span>
<a name="line-14"></a><span class='hs-cpp'>#ifdef USE_REFLEX_OPTIMIZER</span>
<a name="line-15"></a><span class='hs-comment'>{-# OPTIONS_GHC -fplugin=Reflex.Optimizer #-}</span>
<a name="line-16"></a><span class='hs-cpp'>#endif</span>
<a name="line-17"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>EventWriter</span>
<a name="line-18"></a>  <span class='hs-layout'>(</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>runEventWriterT</span>
<a name="line-20"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>EventWriter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-21"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>runWithReplaceEventWriterTWith</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sequenceDMapWithAdjustEventWriterTWith</span>
<a name="line-23"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>withEventWriterT</span>
<a name="line-24"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>Host</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>PerformEvent</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>PostBuild</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>Query</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>Requester</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Reflex</span><span class='hs-varop'>.</span><span class='hs-conid'>TriggerEvent</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-33"></a>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Identity</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Reader</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Ref</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>State</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dependent</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>DMap</span><span class='hs-layout'>,</span> <span class='hs-conid'>DSum</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Dependent</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>DMap</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Foldable</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Functor</span><span class='hs-varop'>.</span><span class='hs-conid'>Compose</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Functor</span><span class='hs-varop'>.</span><span class='hs-conid'>Misc</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>GADT</span><span class='hs-varop'>.</span><span class='hs-conid'>Compare</span> <span class='hs-layout'>(</span><span class='hs-conid'>GEq</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>GCompare</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>GOrdering</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IntMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntMap</span><span class='hs-layout'>)</span>
<a name="line-46"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IntMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IntMap</span>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Semigroup</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Some</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span><span class='hs-layout'>)</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Tuple</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Type</span><span class='hs-varop'>.</span><span class='hs-conid'>Equality</span>
<a name="line-53"></a>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unsafe</span><span class='hs-varop'>.</span><span class='hs-conid'>Coerce</span>
<a name="line-55"></a>
<a name="line-56"></a><a name="EventWriter"></a><span class='hs-comment'>-- | 'EventWriter' efficiently collects 'Event' values using 'tellEvent'</span>
<a name="line-57"></a><a name="EventWriter"></a><span class='hs-comment'>-- and combines them monoidally to provide an 'Event' result.</span>
<a name="line-58"></a><a name="EventWriter"></a><span class='hs-keyword'>class</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>EventWriter</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-keyword'>where</span>
<a name="line-59"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="TellId"></a><span class='hs-comment'>{-# DEPRECATED TellId "Do not construct this directly; use tellId instead" #-}</span>
<a name="line-62"></a><a name="TellId"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span> <span class='hs-varid'>x</span>
<a name="line-63"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TellId</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ WARNING: Do not construct this directly; use 'TellId' instead</span>
<a name="line-64"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Enum</span><span class='hs-layout'>)</span>
<a name="line-65"></a>
<a name="line-66"></a><a name="tellId"></a><span class='hs-definition'>tellId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span> <span class='hs-varid'>w</span>
<a name="line-67"></a><span class='hs-definition'>tellId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TellId</span>
<a name="line-68"></a><span class='hs-comment'>{-# INLINE tellId #-}</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="tellIdRefl"></a><span class='hs-definition'>tellIdRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>w</span> <span class='hs-conop'>:~:</span> <span class='hs-varid'>x</span>
<a name="line-71"></a><span class='hs-definition'>tellIdRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeCoerce</span> <span class='hs-conid'>Refl</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="withTellIdRefl"></a><span class='hs-definition'>withTellIdRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>~</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-74"></a><span class='hs-definition'>withTellIdRefl</span> <span class='hs-varid'>tid</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tellIdRefl</span> <span class='hs-varid'>tid</span> <span class='hs-keyword'>of</span>
<a name="line-75"></a>  <span class='hs-conid'>Refl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="instance%20GEq%20(TellId%20w)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>GEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-78"></a>  <span class='hs-varid'>a</span> <span class='hs-varop'>`geq`</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span>
<a name="line-79"></a>    <span class='hs-varid'>withTellIdRefl</span> <span class='hs-varid'>a</span> <span class='hs-varop'>$</span>
<a name="line-80"></a>    <span class='hs-varid'>withTellIdRefl</span> <span class='hs-varid'>b</span> <span class='hs-varop'>$</span>
<a name="line-81"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-varid'>b</span>
<a name="line-82"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Refl</span>
<a name="line-83"></a>    <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-84"></a>
<a name="line-85"></a><a name="instance%20GCompare%20(TellId%20w)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>GCompare</span> <span class='hs-layout'>(</span><span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-86"></a>  <span class='hs-varid'>a</span> <span class='hs-varop'>`gcompare`</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span>
<a name="line-87"></a>    <span class='hs-varid'>withTellIdRefl</span> <span class='hs-varid'>a</span> <span class='hs-varop'>$</span>
<a name="line-88"></a>    <span class='hs-varid'>withTellIdRefl</span> <span class='hs-varid'>b</span> <span class='hs-varop'>$</span>
<a name="line-89"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-90"></a>      <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GLT</span>
<a name="line-91"></a>      <span class='hs-conid'>EQ</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GEQ</span>
<a name="line-92"></a>      <span class='hs-conid'>GT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GGT</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="EventWriterState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EventWriterState</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EventWriterState</span>
<a name="line-95"></a>  <span class='hs-layout'>{</span> <span class='hs-sel'>_eventWriterState_nextId</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span> <span class='hs-comment'>-- Always negative (and decreasing over time)</span>
<a name="line-96"></a>  <span class='hs-layout'>,</span> <span class='hs-sel'>_eventWriterState_told</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>DSum</span> <span class='hs-layout'>(</span><span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- In increasing order</span>
<a name="line-97"></a>  <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a><a name="EventWriterT"></a><span class='hs-comment'>-- | A basic implementation of 'EventWriter'.</span>
<a name="line-100"></a><a name="EventWriterT"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unEventWriterT</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StateT</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterState</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-101"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>,</span> <span class='hs-conid'>Applicative</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monad</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadFix</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadIO</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadException</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadAsyncException</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="runEventWriterT"></a><span class='hs-comment'>-- | Run a 'EventWriterT' action.</span>
<a name="line-104"></a><span class='hs-definition'>runEventWriterT</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-varid'>w</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-105"></a><span class='hs-definition'>runEventWriterT</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-106"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>requests</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runStateT</span> <span class='hs-varid'>a</span> <span class='hs-varop'>$</span> <span class='hs-conid'>EventWriterState</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-107"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>combineResults</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TellId</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-conid'>Identity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>w</span>
<a name="line-108"></a>      <span class='hs-varid'>combineResults</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sconcat</span>
<a name="line-109"></a>        <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- Unconditional; 'merge' guarantees that it will only fire with non-empty DMaps</span>
<a name="line-110"></a>        <span class='hs-varop'>.</span> <span class='hs-conid'>DMap</span><span class='hs-varop'>.</span><span class='hs-varid'>foldlWithKey</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>vs</span> <span class='hs-varid'>tid</span> <span class='hs-layout'>(</span><span class='hs-conid'>Identity</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withTellIdRefl</span> <span class='hs-varid'>tid</span> <span class='hs-varop'>$</span> <span class='hs-varid'>v</span> <span class='hs-conop'>:</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-comment'>-- This is where we finally reverse the DMap to get things in the correct order</span>
<a name="line-111"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>combineResults</span> <span class='hs-varop'>$</span> <span class='hs-varid'>merge</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DMap</span><span class='hs-varop'>.</span><span class='hs-varid'>fromDistinctAscList</span> <span class='hs-varop'>$</span> <span class='hs-sel'>_eventWriterState_told</span> <span class='hs-varid'>requests</span><span class='hs-layout'>)</span> <span class='hs-comment'>--TODO: We can probably make this fromDistinctAscList more efficient by knowing the length in advance, but this will require exposing internals of DMap; also converting it to use a strict list might help</span>
<a name="line-112"></a>
<a name="line-113"></a><a name="instance%20EventWriter%20t%20w%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>EventWriter</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-114"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>old</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-115"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>myId</span> <span class='hs-keyglyph'>=</span> <span class='hs-sel'>_eventWriterState_nextId</span> <span class='hs-varid'>old</span>
<a name="line-116"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>EventWriterState</span>
<a name="line-117"></a>       <span class='hs-layout'>{</span> <span class='hs-sel'>_eventWriterState_nextId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>myId</span>
<a name="line-118"></a>       <span class='hs-layout'>,</span> <span class='hs-sel'>_eventWriterState_told</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tellId</span> <span class='hs-varid'>myId</span> <span class='hs-conop'>:=&gt;</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-sel'>_eventWriterState_told</span> <span class='hs-varid'>old</span>
<a name="line-119"></a>       <span class='hs-layout'>}</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="instance%20EventWriter%20t%20w%20(ReaderT%20r%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>EventWriter</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>EventWriter</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReaderT</span> <span class='hs-varid'>r</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-122"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tellEvent</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="instance%20MonadTrans%20(EventWriterT%20t%20w)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadTrans</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-125"></a>  <span class='hs-varid'>lift</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lift</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="instance%20MonadSample%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadSample</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadSample</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-128"></a>  <span class='hs-varid'>sample</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sample</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="instance%20MonadHold%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-131"></a>  <span class='hs-comment'>{-# INLINABLE hold #-}</span>
<a name="line-132"></a>  <span class='hs-varid'>hold</span> <span class='hs-varid'>v0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hold</span> <span class='hs-varid'>v0</span>
<a name="line-133"></a>  <span class='hs-comment'>{-# INLINABLE holdDyn #-}</span>
<a name="line-134"></a>  <span class='hs-varid'>holdDyn</span> <span class='hs-varid'>v0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>holdDyn</span> <span class='hs-varid'>v0</span>
<a name="line-135"></a>  <span class='hs-comment'>{-# INLINABLE holdIncremental #-}</span>
<a name="line-136"></a>  <span class='hs-varid'>holdIncremental</span> <span class='hs-varid'>v0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>holdIncremental</span> <span class='hs-varid'>v0</span>
<a name="line-137"></a>  <span class='hs-comment'>{-# INLINABLE buildDynamic #-}</span>
<a name="line-138"></a>  <span class='hs-varid'>buildDynamic</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>buildDynamic</span> <span class='hs-varid'>a0</span>
<a name="line-139"></a>  <span class='hs-comment'>{-# INLINABLE headE #-}</span>
<a name="line-140"></a>  <span class='hs-varid'>headE</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>headE</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="instance%20Adjustable%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>Adjustable</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Adjustable</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-143"></a>  <span class='hs-varid'>runWithReplace</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runWithReplaceEventWriterTWith</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runWithReplace</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span>
<a name="line-144"></a>  <span class='hs-varid'>traverseIntMapWithKeyWithAdjust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceIntMapWithAdjustEventWriterTWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>traverseIntMapWithKeyWithAdjust</span> <span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span><span class='hs-layout'>)</span> <span class='hs-varid'>patchIntMapNewElements</span> <span class='hs-varid'>mergeIntIncremental</span>
<a name="line-145"></a>  <span class='hs-varid'>traverseDMapWithKeyWithAdjust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceDMapWithAdjustEventWriterTWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>traverseDMapWithKeyWithAdjust</span> <span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span><span class='hs-layout'>)</span> <span class='hs-varid'>mapPatchDMap</span> <span class='hs-varid'>weakenPatchDMapWith</span> <span class='hs-varid'>patchMapNewElements</span> <span class='hs-varid'>mergeMapIncremental</span>
<a name="line-146"></a>  <span class='hs-varid'>traverseDMapWithKeyWithAdjustWithMove</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceDMapWithAdjustEventWriterTWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>traverseDMapWithKeyWithAdjustWithMove</span> <span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span><span class='hs-layout'>)</span> <span class='hs-varid'>mapPatchDMapWithMove</span> <span class='hs-varid'>weakenPatchDMapWithMoveWith</span> <span class='hs-varid'>patchMapWithMoveNewElements</span> <span class='hs-varid'>mergeMapIncrementalWithMove</span>
<a name="line-147"></a>
<a name="line-148"></a><a name="instance%20Requester%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Requester</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Requester</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-149"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>Request</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Request</span> <span class='hs-varid'>m</span>
<a name="line-150"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>Response</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Response</span> <span class='hs-varid'>m</span>
<a name="line-151"></a>  <span class='hs-varid'>requesting</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>requesting</span>
<a name="line-152"></a>  <span class='hs-varid'>requesting_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>requesting_</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="runWithReplaceEventWriterTWith"></a><span class='hs-comment'>-- | Given a function like 'runWithReplace' for the underlying monad, implement</span>
<a name="line-155"></a><span class='hs-comment'>-- 'runWithReplace' for 'EventWriterT'.  This is necessary when the underlying</span>
<a name="line-156"></a><span class='hs-comment'>-- monad doesn't have a 'Adjustable' instance or to override the default</span>
<a name="line-157"></a><span class='hs-comment'>-- 'Adjustable' behavior.</span>
<a name="line-158"></a><span class='hs-definition'>runWithReplaceEventWriterTWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>m</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-159"></a>                               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>b'</span><span class='hs-varop'>.</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>b'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-160"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-161"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-162"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-163"></a><span class='hs-definition'>runWithReplaceEventWriterTWith</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a0</span> <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-164"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>result0</span><span class='hs-layout'>,</span> <span class='hs-varid'>result'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>runEventWriterT</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmapCheap</span> <span class='hs-varid'>runEventWriterT</span> <span class='hs-varid'>a'</span>
<a name="line-165"></a>  <span class='hs-varid'>request</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>holdDyn</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varid'>result0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmapCheap</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>result'</span>
<a name="line-166"></a>  <span class='hs-comment'>-- We add these two separately to take advantage of the free merge being done later.  The coincidence case must come first so that it has precedence if both fire simultaneously.  (Really, we should probably block the 'switch' whenever 'updated' fires, but switchPromptlyDyn has the same issue.)</span>
<a name="line-167"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coincidence</span> <span class='hs-varop'>$</span> <span class='hs-varid'>updated</span> <span class='hs-varid'>request</span>
<a name="line-168"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>switch</span> <span class='hs-varop'>$</span> <span class='hs-varid'>current</span> <span class='hs-varid'>request</span>
<a name="line-169"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varid'>result0</span><span class='hs-layout'>,</span> <span class='hs-varid'>fmapCheap</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>result'</span><span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="sequenceIntMapWithAdjustEventWriterTWith"></a><span class='hs-comment'>-- | Like 'runWithReplaceEventWriterTWith', but for 'sequenceIntMapWithAdjust'.</span>
<a name="line-172"></a><span class='hs-definition'>sequenceIntMapWithAdjustEventWriterTWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-varid'>p</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span> <span class='hs-varid'>v'</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-conid'>Functor</span> <span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-conid'>Patch</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PatchTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>IntMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-173"></a>                                       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span>   <span class='hs-layout'>(</span><span class='hs-conid'>IntMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Key</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-174"></a>                                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntMap</span> <span class='hs-varid'>v</span>
<a name="line-175"></a>                                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-176"></a>                                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-177"></a>                                          <span class='hs-layout'>)</span>
<a name="line-178"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-179"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Incremental</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntMap</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-180"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Key</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span>
<a name="line-181"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntMap</span> <span class='hs-varid'>v</span>
<a name="line-182"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-183"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>IntMap</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-184"></a><span class='hs-definition'>sequenceIntMapWithAdjustEventWriterTWith</span> <span class='hs-varid'>base</span> <span class='hs-varid'>patchNewElements</span> <span class='hs-varid'>mergePatchIncremental</span> <span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-185"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>f'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Key</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span>
<a name="line-186"></a>      <span class='hs-varid'>f'</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>runEventWriterT</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-187"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>children0</span><span class='hs-layout'>,</span> <span class='hs-varid'>children'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>base</span> <span class='hs-varid'>f'</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span>
<a name="line-188"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>result0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>children0</span>
<a name="line-189"></a>      <span class='hs-varid'>result'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmapCheap</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>children'</span>
<a name="line-190"></a>      <span class='hs-varid'>requests0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-191"></a>      <span class='hs-varid'>requests0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>children0</span>
<a name="line-192"></a>      <span class='hs-varid'>requests'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-193"></a>      <span class='hs-varid'>requests'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmapCheap</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>children'</span>
<a name="line-194"></a>  <span class='hs-varid'>childRequestMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Incremental</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>holdIncremental</span> <span class='hs-varid'>requests0</span> <span class='hs-varid'>requests'</span>
<a name="line-195"></a>  <span class='hs-comment'>-- We add these two separately to take advantage of the free merge being done later.  The coincidence case must come first so that it has precedence if both fire simultaneously.  (Really, we should probably block the 'switch' whenever 'updated' fires, but switchPromptlyDyn has the same issue.)</span>
<a name="line-196"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coincidence</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fforCheap</span> <span class='hs-varid'>requests'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mconcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>patchNewElements</span> <span class='hs-varid'>p</span> <span class='hs-comment'>--TODO: Create a mergeIncrementalPromptly, and use that to eliminate this 'coincidence'</span>
<a name="line-197"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fforMaybeCheap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mergePatchIncremental</span> <span class='hs-varid'>childRequestMap</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-198"></a>    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-199"></a>    <span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sconcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>t</span>
<a name="line-200"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result0</span><span class='hs-layout'>,</span> <span class='hs-varid'>result'</span><span class='hs-layout'>)</span>
<a name="line-201"></a>
<a name="line-202"></a><a name="sequenceDMapWithAdjustEventWriterTWith"></a><span class='hs-comment'>-- | Like 'runWithReplaceEventWriterTWith', but for 'sequenceDMapWithAdjust'.</span>
<a name="line-203"></a><span class='hs-definition'>sequenceDMapWithAdjustEventWriterTWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-varid'>p</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>w</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-varid'>v'</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-conid'>Patch</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PatchTarget</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-204"></a>                                       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span>   <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-205"></a>                                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span>
<a name="line-206"></a>                                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-207"></a>                                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>DMap</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-208"></a>                                          <span class='hs-layout'>)</span>
<a name="line-209"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span>
<a name="line-210"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-layout'>(</span><span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-211"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-212"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Incremental</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-213"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>v'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-214"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span>
<a name="line-215"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-216"></a>                                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>DMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-217"></a><span class='hs-definition'>sequenceDMapWithAdjustEventWriterTWith</span> <span class='hs-varid'>base</span> <span class='hs-varid'>mapPatch</span> <span class='hs-varid'>weakenPatchWith</span> <span class='hs-varid'>patchNewElements</span> <span class='hs-varid'>mergePatchIncremental</span> <span class='hs-varid'>f</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-218"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>f'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Compose</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-219"></a>      <span class='hs-varid'>f'</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Compose</span> <span class='hs-varop'>.</span> <span class='hs-varid'>swap</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>runEventWriterT</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-220"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>children0</span><span class='hs-layout'>,</span> <span class='hs-varid'>children'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>base</span> <span class='hs-varid'>f'</span> <span class='hs-varid'>dm0</span> <span class='hs-varid'>dm'</span>
<a name="line-221"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>result0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DMap</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getCompose</span><span class='hs-layout'>)</span> <span class='hs-varid'>children0</span>
<a name="line-222"></a>      <span class='hs-varid'>result'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fforCheap</span> <span class='hs-varid'>children'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapPatch</span> <span class='hs-varop'>$</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getCompose</span>
<a name="line-223"></a>      <span class='hs-varid'>requests0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-224"></a>      <span class='hs-varid'>requests0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>weakenDMapWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getCompose</span><span class='hs-layout'>)</span> <span class='hs-varid'>children0</span>
<a name="line-225"></a>      <span class='hs-varid'>requests'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-226"></a>      <span class='hs-varid'>requests'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fforCheap</span> <span class='hs-varid'>children'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>weakenPatchWith</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getCompose</span>
<a name="line-227"></a>  <span class='hs-varid'>childRequestMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Incremental</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>p'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Some</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>holdIncremental</span> <span class='hs-varid'>requests0</span> <span class='hs-varid'>requests'</span>
<a name="line-228"></a>  <span class='hs-comment'>-- We add these two separately to take advantage of the free merge being done later.  The coincidence case must come first so that it has precedence if both fire simultaneously.  (Really, we should probably block the 'switch' whenever 'updated' fires, but switchPromptlyDyn has the same issue.)</span>
<a name="line-229"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coincidence</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fforCheap</span> <span class='hs-varid'>requests'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mconcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>patchNewElements</span> <span class='hs-varid'>p</span> <span class='hs-comment'>--TODO: Create a mergeIncrementalPromptly, and use that to eliminate this 'coincidence'</span>
<a name="line-230"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fforMaybeCheap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mergePatchIncremental</span> <span class='hs-varid'>childRequestMap</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>toList</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-231"></a>    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-232"></a>    <span class='hs-varid'>h</span> <span class='hs-conop'>:</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sconcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>h</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>t</span>
<a name="line-233"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result0</span><span class='hs-layout'>,</span> <span class='hs-varid'>result'</span><span class='hs-layout'>)</span>
<a name="line-234"></a>
<a name="line-235"></a><a name="instance%20PerformEvent%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>PerformEvent</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PerformEvent</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-236"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>Performable</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Performable</span> <span class='hs-varid'>m</span>
<a name="line-237"></a>  <span class='hs-varid'>performEvent_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>performEvent_</span>
<a name="line-238"></a>  <span class='hs-varid'>performEvent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>performEvent</span>
<a name="line-239"></a>
<a name="line-240"></a><a name="instance%20PostBuild%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>PostBuild</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>PostBuild</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-241"></a>  <span class='hs-varid'>getPostBuild</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varid'>getPostBuild</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="instance%20TriggerEvent%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>TriggerEvent</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TriggerEvent</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-244"></a>  <span class='hs-varid'>newTriggerEvent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varid'>newTriggerEvent</span>
<a name="line-245"></a>  <span class='hs-varid'>newTriggerEventWithOnComplete</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varid'>newTriggerEventWithOnComplete</span>
<a name="line-246"></a>  <span class='hs-varid'>newEventWithLazyTriggerWithOnComplete</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>newEventWithLazyTriggerWithOnComplete</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="instance%20MonadReader%20r%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadReader</span> <span class='hs-varid'>r</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadReader</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-249"></a>  <span class='hs-varid'>ask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varid'>ask</span>
<a name="line-250"></a>  <span class='hs-varid'>local</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapStateT</span> <span class='hs-layout'>(</span><span class='hs-varid'>local</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-251"></a>  <span class='hs-varid'>reader</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>reader</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="instance%20MonadRef%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadRef</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-254"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>Ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Ref</span> <span class='hs-varid'>m</span>
<a name="line-255"></a>  <span class='hs-varid'>newRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>newRef</span>
<a name="line-256"></a>  <span class='hs-varid'>readRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>readRef</span>
<a name="line-257"></a>  <span class='hs-varid'>writeRef</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>writeRef</span> <span class='hs-varid'>r</span>
<a name="line-258"></a>
<a name="line-259"></a><a name="instance%20MonadAtomicRef%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadAtomicRef</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadAtomicRef</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-260"></a>  <span class='hs-varid'>atomicModifyRef</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>atomicModifyRef</span> <span class='hs-varid'>r</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="instance%20MonadReflexCreateTrigger%20t%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadReflexCreateTrigger</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadReflexCreateTrigger</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-263"></a>  <span class='hs-varid'>newEventWithTrigger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>newEventWithTrigger</span>
<a name="line-264"></a>  <span class='hs-varid'>newFanEventWithTrigger</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newFanEventWithTrigger</span> <span class='hs-varid'>f</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="instance%20MonadQuery%20t%20q%20(EventWriterT%20t%20w%20m)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadQuery</span> <span class='hs-varid'>t</span> <span class='hs-varid'>q</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadQuery</span> <span class='hs-varid'>t</span> <span class='hs-varid'>q</span> <span class='hs-layout'>(</span><span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-267"></a>  <span class='hs-varid'>tellQueryIncremental</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tellQueryIncremental</span>
<a name="line-268"></a>  <span class='hs-varid'>askQueryResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varid'>askQueryResult</span>
<a name="line-269"></a>  <span class='hs-varid'>queryIncremental</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>queryIncremental</span>
<a name="line-270"></a>
<a name="line-271"></a><a name="withEventWriterT"></a><span class='hs-comment'>-- | Map a function over the output of a 'EventWriterT'.</span>
<a name="line-272"></a><span class='hs-definition'>withEventWriterT</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-conid'>Semigroup</span> <span class='hs-varid'>w'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Reflex</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadHold</span> <span class='hs-varid'>t</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadFix</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-273"></a>                 <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>w'</span><span class='hs-layout'>)</span>
<a name="line-274"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-275"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EventWriterT</span> <span class='hs-varid'>t</span> <span class='hs-varid'>w'</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-276"></a><span class='hs-definition'>withEventWriterT</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ew</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-277"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-278"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runEventWriterT</span> <span class='hs-varid'>ew</span>
<a name="line-279"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>e</span>
<a name="line-280"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-281"></a>  <span class='hs-varid'>tellEvent</span> <span class='hs-varid'>e</span>
<a name="line-282"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
</pre></body>
</html>
